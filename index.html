<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neumorphic Scientific Calculator</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">
  <link rel="icon" href="icons/icon-192.png" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
:root {
            --bg: #f0fff4;
            --surface: #e8f5e9;
            --shadow-light: #ffffff;
            --shadow-dark: #d0e6d1;
            --text: #2e7d32;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: start; /* Keep container aligned to the top */
            min-height: 100vh;
            padding: 30px 10px;
        }

        .container {
            width: 100%;
            max-width: 420px;
            padding: 20px;
            background: var(--surface);
            border-radius: 30px;
            box-shadow: 15px 15px 30px var(--shadow-dark), -15px -15px 30px var(--shadow-light);
        }

        .display {
            background: var(--surface);
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            border-radius: 20px;
            padding: 20px;
            font-size: 2em;
            color: var(--text);
            text-align: right;
            margin-bottom: 20px;
            word-wrap: break-word;
            min-height: 1.2em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }

        .btn {
            background: var(--surface);
            color: var(--text);
            border: none;
            padding: 15px;
            font-size: 1.1em;
            border-radius: 20px;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn:active {
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .btn-utils {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .tab {
            display: none;
        }

        .tab.active {
            display: block;
        }

        .nav-bar {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .nav-btn {
            padding: 10px 15px;
            border-radius: 15px;
            background: var(--surface);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            border: none;
            font-size: 1em;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-btn:active {
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .home {
            text-align: center;
            padding-top: 50px;
            padding-bottom: 50px;
        }

        .home .btn {
            display: block;
            margin: 20px auto 0 auto;
            max-width: 200px;
            width: 100%;
        }

        input {
            width: calc(100% - 24px); /* Account for padding */
            padding: 12px;
            border-radius: 20px;
            font-size: 1em;
            border: none;
            margin: 10px 0;
            background: var(--surface);
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            color: var(--text);
            outline: none;
        }

        input:focus {
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }

        .bmi-result-container {
            margin-top: 10px;
            padding: 15px;
            border-radius: 15px;
            background: var(--surface);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            color: var(--text);
            text-align: center;
        }

        .bmi-underweight { color: #ff9800; font-weight: bold; }
        .bmi-normal { color: #4caf50; font-weight: bold; }
        .bmi-overweight { color: #ff5722; font-weight: bold; }
        .bmi-obese { color: #d32f2f; font-weight: bold; }

        .feedback-message {
            margin-top: 10px;
            padding: 8px 15px;
            background-color: #d4edda;
            color: #155724;
            border-radius: 5px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }

        .feedback-message.show {
            opacity: 1;
        }

        /* History Styles */
        .history-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 20px;
            background: var(--surface);
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .history-list {
            max-height: 150px;
            overflow-y: auto;
            color: var(--text);
        }

        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--shadow-dark);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .history-item:hover {
            background-color: var(--bg);
        }

        .history-item .expression {
            display: block;
            font-size: 0.9em;
            opacity: 0.8;
        }

        .history-item .result {
            display: block;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-header h3 {
            margin: 0;
            color: var(--text);
        }

        .clear-history-btn {
            padding: 5px 10px;
            font-size: 0.8em;
            background: var(--surface);
            color: var(--text);
            border: none;
            border-radius: 10px;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            cursor: pointer;
        }

        .clear-history-btn:active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
        }


  </style>
</head>
<body>
<div class="container">
    <div id="home" class="home">
        <h2 style="color: var(--text)">Welcome!</h2>
        <p style="color: var(--text)">Explore Scientific Calculator & Tools</p>
        <button class="btn" onclick="enterApp()">Enter App</button>
    </div>

    <div id="nav" class="nav-bar" style="display: none">
        <button class="nav-btn" onclick="showTab('calc')">Calculator</button>
        <button class="nav-btn" onclick="showTab('bmi')">BMI</button>
        <button class="nav-btn" onclick="showTab('bodyfat')">Body Fat</button>
        <button class="nav-btn" onclick="goHome()">Home</button>
    </div>

    <div id="calc" class="tab">
        <h2 style="color: var(--text); text-align:center;">Scientific Calculator</h2>
        <div class="display" id="display">0</div>
        <div class="btn-grid">
            <button class="btn" onclick="press('π')">π</button>
            <button class="btn" onclick="press('e')">e</button>
            <button class="btn" onclick="press('^')">^</button>
            <button class="btn" onclick="press('%')">%</button>
            <button class="btn" onclick="clearDisplay()">C</button>

            <button class="btn" onclick="press('sin(')">sin</button>
            <button class="btn" onclick="press('cos(')">cos</button>
            <button class="btn" onclick="press('tan(')">tan</button>
            <button class="btn" onclick="press('sqrt(')">√</button>
            <button class="btn" onclick="press('log10(')">log</button>

            <button class="btn" onclick="press('7')">7</button>
            <button class="btn" onclick="press('8')">8</button>
            <button class="btn" onclick="press('9')">9</button>
            <button class="btn" onclick="press('/')">÷</button>
            <button class="btn" onclick="press('!')">!</button>

            <button class="btn" onclick="press('4')">4</button>
            <button class="btn" onclick="press('5')">5</button>
            <button class="btn" onclick="press('6')">6</button>
            <button class="btn" onclick="press('*')">×</button>
            <button class="btn" onclick="press('(')">(</button>

            <button class="btn" onclick="press('1')">1</button>
            <button class="btn" onclick="press('2')">2</button>
            <button class="btn" onclick="press('3')">3</button>
            <button class="btn" onclick="press('-')">−</button>
            <button class="btn" onclick="press(')')">)</button>

            <button class="btn" onclick="press('0')">0</button>
            <button class="btn" onclick="press('.')">.</button>
            <button class="btn" onclick="calculate()">=</button>
            <button class="btn" onclick="press('+')">+</button>
            <button class="btn" onclick="press('log(')">ln</button>
        </div>
           <div class="btn-utils">
            <button class="btn" onclick="exportResult()">Export PDF</button>
        </div>
        <div id="exportFeedback" class="feedback-message"></div>

        <div class="history-container">
            <div class="history-header">
                <h3>History</h3>
                <button class="clear-history-btn" onclick="clearHistory()">Clear History</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <div id="bmi" class="tab">
        <h2 style="color: var(--text); text-align:center;">BMI Calculator</h2>
        <label for="bmiWeight" style="color: var(--text)">Weight (kg)</label>
        <input id="bmiWeight" type="number" placeholder="e.g., 60">
        <label for="bmiHeight" style="color: var(--text)">Height (cm)</label>
        <input id="bmiHeight" type="number" placeholder="e.g., 170">
        <button onclick="calculateBMI()" class="btn">Calculate BMI</button>
        <div id="bmiResult" class="bmi-result-container" style="display: none;"></div>
        <div id="bmiError" class="feedback-message" style="background-color: #f8d7da; color: #721c24;"></div>
    </div>

    <div id="bodyfat" class="tab">
        <h2 style="color: var(--text); text-align:center;">Body Fat % Estimator</h2>
        <label for="bfWeight" style="color: var(--text)">Weight (kg)</label>
        <input id="bfWeight" type="number" placeholder="e.g., 70">
        <label for="bfWaist" style="color: var(--text)">Waist Circumference (cm)</label>
        <input id="bfWaist" type="number" placeholder="e.g., 85">
        <button onclick="estimateBodyFat()" class="btn">Estimate</button>
        <div id="bfResult" class="bmi-result-container" style="display: none;"></div>
        <div id="bfError" class="feedback-message" style="background-color: #f8d7da; color: #721c24;"></div>
    </div>
</div>

<script>
    let expression = '';
    let isResultDisplayed = false; // Flag to track if the display shows a result

    const BMI_HEIGHT_CONVERSION_FACTOR = 100;
    const BF_WAIST_FACTOR = 0.74;
    const BF_WEIGHT_FACTOR = 0.082;
    const BF_CONSTANT = 34.89;

    function press(val) {
        const lastChar = expression.slice(-1);
        const isOperator = ['+', '-', '*', '/', '^', '%'].includes(val);
        const isNumberOrFunction = /[0-9πe.(]/.test(val) || ['sin(','cos(','tan(','sqrt(','log(','log10('].includes(val);
        
        // If a result is on display and user presses a number/function, start a new calculation
        if (isResultDisplayed && isNumberOrFunction) {
            expression = '';
        }
        isResultDisplayed = false; // Reset flag on any key press

        const lastCharIsOperator = ['+', '-', '*', '/', '^', '.'].includes(lastChar);
        
        if (isOperator && lastCharIsOperator && val !== '-') {
            // Replace operator if the last character is an operator and it's not a minus sign (for negative numbers)
            expression = expression.slice(0, -1) + val;
        } else if (val === '!' && (!/\d$/.test(lastChar) && lastChar !== ')')) {
            // Prevent factorial without a preceding number or closing parenthesis
            return;
        } else if (val === '%' && (!/\d$/.test(lastChar) && lastChar !== ')')) {
            // Prevent percentage without a preceding number or closing parenthesis
            return;
        } else if (val === '.' && (lastChar === '.' || expression.split(/[\+\-\*\/%^]/).pop().includes('.'))) {
            // Prevent multiple decimals in a single number
            return;
        } else {
            expression += val;
        }
        document.getElementById('display').innerText = expression || '0';
    }

    function clearDisplay() {
        expression = '';
        isResultDisplayed = false;
        document.getElementById('display').innerText = '0';
    }

    function factorial(n) {
        if (n < 0 || !Number.isInteger(n)) return NaN;
        if (n === 0 || n === 1) return 1;
        let result = 1;
        for (let i = 2; i <= n; i++) {
            result *= i;
        }
        return result;
    }

    // Helper functions for trigonometric and logarithmic calculations
    function sinR(x) {
        return Math.sin(x * Math.PI / 180); // Convert degrees to radians for sin
    }

    function cosR(x) {
        return Math.cos(x * Math.PI / 180); // Convert degrees to radians for cos
    }

    function tanR(x) {
        return Math.tan(x * Math.PI / 180); // Convert degrees to radians for tan
    }

    function logB(base, x) {
        return Math.log(x) / Math.log(base); // Generic log base function
    }

    function log10B(x) {
        return Math.log10(x); // Base 10 log
    }

    function lnB(x) {
        return Math.log(x); // Natural log (base e)
    }

    function calculate() {
        if (expression.trim() === '' || isResultDisplayed) return;
        
        const originalExpression = expression;
        try {
            let processedExpression = expression
                .replace(/π/g, 'Math.PI')
                .replace(/e/g, 'Math.E')
                .replace(/sqrt\(/g, 'Math.sqrt(')
                .replace(/sin\(/g, 'sinR(') // Use helper function for sin
                .replace(/cos\(/g, 'cosR(') // Use helper function for cos
                .replace(/tan\(/g, 'tanR(') // Use helper function for tan
                .replace(/log10\(/g, 'log10B(') // Use helper function for log base 10
                .replace(/log\(/g, 'lnB(') // Use helper function for natural log
                .replace(/\^/g, '**');

            processedExpression = processedExpression.replace(/(\d+(\.\d+)?)!/g, (match, num) => {
                const n = parseFloat(num);
                if (n < 0 || !Number.isInteger(n)) {
                    throw new Error("Factorial is only defined for non-negative integers.");
                }
                return `factorial(${n})`;
            });
            
            processedExpression = processedExpression.replace(/(\d+(\.\d+)?)%/g, (match, num) => {
                return `(${parseFloat(num)} / 100)`;
            });

            // Pass helper functions to the Function constructor
            const evalFunction = new Function('factorial', 'sinR', 'cosR', 'tanR', 'log10B', 'lnB', 'return ' + processedExpression);
            const result = evalFunction(factorial, sinR, cosR, tanR, log10B, lnB);

            if (!Number.isFinite(result)) {
                throw new Error("Result is not a finite number.");
            }

            const formattedResult = result.toString().length > 15 && Math.abs(result) >= 1e10 ? result.toExponential(8) : parseFloat(result.toFixed(10)).toString();
            document.getElementById('display').innerText = formattedResult;
            
            addToHistory(originalExpression, formattedResult);
            
            expression = '' + result;
            isResultDisplayed = true;
        } catch (e) {
            document.getElementById('display').innerText = 'Error';
            expression = '';
            isResultDisplayed = true;
            console.error("Calculator Error:", e);
        }
    }

    function showFeedback(elementId, message, isError = false) {
        const feedbackElement = document.getElementById(elementId);
        feedbackElement.textContent = message;
        if (isError) {
            feedbackElement.style.backgroundColor = '#f8d7da';
            feedbackElement.style.color = '#721c24';
        } else {
            feedbackElement.style.backgroundColor = '#d4edda';
            feedbackElement.style.color = '#155724';
        }
        feedbackElement.classList.add('show');
        setTimeout(() => {
            feedbackElement.classList.remove('show');
            setTimeout(() => { feedbackElement.textContent = ''; }, 500);
        }, 3000);
    }
    
    function exportResult() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const resultToExport = document.getElementById('display').innerText;
        if (resultToExport === '0' || resultToExport === 'Error' || resultToExport === '') {
            showFeedback('exportFeedback', 'Nothing to export.', true);
            return;
        }

        doc.text('Calculator Result:', 10, 10);
        doc.text(resultToExport, 10, 20);
        doc.save('calculator_result.pdf');
        showFeedback('exportFeedback', 'Result exported as PDF!');
    }

    // --- History Functions ---
    function getHistory() {
        return JSON.parse(localStorage.getItem('calcHistory') || '[]');
    }

    function addToHistory(expression, result) {
        const history = getHistory();
        history.unshift({ expression, result });
        if (history.length > 50) {
            history.pop();
        }
        localStorage.setItem('calcHistory', JSON.stringify(history));
        updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
        const history = getHistory();
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = ''; 
        
        history.forEach(item => {
            const entry = document.createElement('div');
            entry.classList.add('history-item');
            
            const expressionSpan = document.createElement('span');
            expressionSpan.className = 'expression';
            expressionSpan.textContent = `${item.expression} =`;
            
            const resultSpan = document.createElement('span');
            resultSpan.className = 'result';
            resultSpan.textContent = item.result;
            
            // Add event listeners directly for robust behavior
            entry.addEventListener('click', () => useFromHistory(item));

            entry.appendChild(expressionSpan);
            entry.appendChild(resultSpan);
            historyList.appendChild(entry);
        });
    }

    function useFromHistory(historyItem) {
        expression = historyItem.expression;
        document.getElementById('display').innerText = expression;
        isResultDisplayed = false; // Allow immediate calculation of the restored expression
    }
    
    function clearHistory() {
        if (confirm('Are you sure you want to clear all history?')) {
            localStorage.removeItem('calcHistory');
            updateHistoryDisplay();
        }
    }

    // --- Navigation and Tab Functions ---
    function enterApp() {
        document.getElementById('home').style.display = 'none';
        document.getElementById('nav').style.display = 'flex';
        showTab('calc');
    }

    function showTab(id) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        if (id === 'calc') {
            updateHistoryDisplay();
        }

        document.getElementById('bmiResult').style.display = 'none';
        document.getElementById('bmiError').textContent = '';
        document.getElementById('bmiError').classList.remove('show');
        document.getElementById('bfResult').style.display = 'none';
        document.getElementById('bfError').textContent = '';
        document.getElementById('bfError').classList.remove('show');
    }

    function goHome() {
        document.getElementById('home').style.display = 'block';
        document.getElementById('nav').style.display = 'none';
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    }

    // --- Health Calculators ---
    function calculateBMI() {
        // ... (This function is unchanged and correct)
        const bmiWeightInput = document.getElementById('bmiWeight');
        const bmiHeightInput = document.getElementById('bmiHeight');
        const bmiResultDiv = document.getElementById('bmiResult');
        const bmiErrorDiv = document.getElementById('bmiError');
        const weight = parseFloat(bmiWeightInput.value);
        const height = parseFloat(bmiHeightInput.value);
        if (isNaN(weight) || isNaN(height) || weight <= 0 || height <= 0) {
            bmiResultDiv.style.display = 'none';
            showFeedback('bmiError', 'Please enter valid positive numbers for weight and height.', true);
            return;
        }
        bmiErrorDiv.textContent = '';
        bmiErrorDiv.classList.remove('show');
        const bmi = weight / ((height / BMI_HEIGHT_CONVERSION_FACTOR) ** 2);
        let classification = '', colorClass = '', tip = '';
        if (bmi < 18.5) {
            classification = 'Underweight'; colorClass = 'bmi-underweight'; tip = 'Consider a balanced diet rich in calories and consult a nutritionist.';
        } else if (bmi < 24.9) {
            classification = 'Normal'; colorClass = 'bmi-normal'; tip = 'Great! Maintain your current lifestyle.';
        } else if (bmi < 29.9) {
            classification = 'Overweight'; colorClass = 'bmi-overweight'; tip = 'Consider regular exercise and a healthy diet.';
        } else {
            classification = 'Obese'; colorClass = 'bmi-obese'; tip = 'Consult a healthcare professional for a tailored plan.';
        }
        bmiResultDiv.innerHTML = `
            <div>
                Your BMI is <span class="${colorClass}">${bmi.toFixed(2)}</span><br>
                <span>Classification: <span class="${colorClass}">${classification}</span></span>
                <p style="font-size:0.9em; margin-top:5px;">Tip: ${tip}</p>
            </div>`;
        bmiResultDiv.style.display = 'block';
    }

    function estimateBodyFat() {
        // ... (This function is unchanged and correct)
        const bfWeightInput = document.getElementById('bfWeight');
        const bfWaistInput = document.getElementById('bfWaist');
        const bfResultDiv = document.getElementById('bfResult');
        const bfErrorDiv = document.getElementById('bfError');
        const weight = parseFloat(bfWeightInput.value);
        const waist = parseFloat(bfWaistInput.value);
        if (isNaN(weight) || isNaN(waist) || weight <= 0 || waist <= 0) {
            bfResultDiv.style.display = 'none';
            showFeedback('bfError', 'Please enter valid positive numbers for weight and waist circumference.', true);
            return;
        }
        bfErrorDiv.textContent = '';
        bfErrorDiv.classList.remove('show');
        const fatPercent = (waist * BF_WAIST_FACTOR - weight * BF_WEIGHT_FACTOR - BF_CONSTANT).toFixed(2);
        const displayFatPercent = Math.max(0, Math.min(100, fatPercent));
        bfResultDiv.innerHTML = `
            <div>
                Estimated Body Fat %: <span style="font-weight:bold; color:var(--text);">${displayFatPercent}%</span>
                <p style="font-size:0.9em; margin-top:5px;">This is a rough estimate. For accurate results, consult a professional.</p>
            </div>`;
        bfResultDiv.style.display = 'block';
    }

    // ✅ Register service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("Service Worker failed", err));
    }
  </script>
</body>
</html>
